set maximum-size 24M
#set delete-oversized
set default-user "nicholas"
#set allow-multiple
set purge-after none
#set proxy "socks://localhost:9999/"

# These seem to vaguely work okay for me.
set queue-high 5
set queue-low 3

# Use dotlock locking, since FreeBSD doesn't like anything else on NFS.
set lock-types dotlock

# The following strings are replaced in pipe commands and maildir/mbox paths:
#       %a: account name
#       %h: user's home directory
#       %n: user's uid
#       %t: action name if performing action
#       %u: name of user
#       %H: current hour (00-23)
#       %M: current minute (00-59)
#       %S: current second (00-59)
#       %d: current day of the month (00-31)
#       %m: current month (01-12)
#       %y: current year
#       %W: current day of the week (0-6, Sunday is 0)
#       %Y: current day of the year (000-365)
#       %Q: current quarter (1-4)

# Macro holding the path where the maildirs are.
$path = "%h/mail"

# Create an action called "drop" that will just drop any mail.
action "drop" drop

# An action to keep mail (leave it on the server).
action "keep" keep

# Various test actions so I get to see if fdm blows up.
action "cat" rewrite "cat"
action "invalid" maildir "${path}/invalid"
action "mbox" mbox "${path}/mbox" compress

# My main inbox and junk mail directories.
action "inbox" maildir "${path}/inbox"
action "junk" maildir "${path}/junk"

# Full disclosire mailing list with preprocess action to strip lame subject.
action "full-disclosure" {
	rewrite "sed 's/^\\(Subject:.*\\)\\[Full-disclosure\\] /\\1/'"
	maildir "${path}/full-disclosure"
}

# Ditto for the marxism mailing list.
action "marxism" {
	rewrite "sed 's/^\\(Subject:.*\\)\\[Marxism\\] /\\1/'"
	maildir "${path}/marxism"
}

# Other simple mailing lists.
action "bugtraq" maildir "${path}/bugtraq"
action "forensics" maildir "${path}/forensics"
action "freebsd-hackers" maildir "${path}/freebsd-hackers"
action "gnu" maildir "${path}/gnu-%1"
action "linux-kernel" maildir "${path}/linux-kernel"
action "netbsd" maildir "${path}/netbsd-%1"
action "openssh-unix-dev" maildir "${path}/openssh-unix-dev"
action "pf" maildir "${path}/pf"
action "secureshell" maildir "${path}/secureshell"

# ------------------------------------------------------------------------------
# These two definitions are part of killfiling - the action appends the 
# message-id to my block list and the macro is used to check that no 
# message-id in the references or in-reply-to headers matches any in the file,
# if it does the mail is dropped later. This means I not only don't need to
# read mail from idiots, I also don't have to read many of (not every client
# adds the headers :-/) the hundred follow-ups telling them they are an idiot.
# Use with care: this can be slow.
#
# I only do this for the openbsd lists at the moment.
# ------------------------------------------------------------------------------
action "die" exec "echo '%[message_id]' >>~/.fdm.ignore"
$is_dead = "echo '%1'|grep -Fqif ~/.fdm.ignore"
# ------------------------------------------------------------------------------

# Mark a maildir entry as read. Stolen from Frank Terbeck's config.
action "mark-read" exec
	'mf="%[mail_file]"; mv "${mf}" "${mf%%/*}/../cur/${mf##*/}:2,S"'

# Account definitions. All passwords and most usernames are read from .netrc.
account "gmx" pop3 server "pop.gmx.net"
account "ntlworld" pop3	server "pop.ntlworld.com"
account "gmail.nicholas.marriott" pop3s server "pop.googlemail.com" port 995
	user "nicholas.marriott@gmail.com"
account "gmail.nicm123" pop3s server "pop.googlemail.com" port 995
	user "nicm123@gmail.com"
account "gmail.nicm321" pop3s server "pop.googlemail.com" port 995
	user "nicm321@gmail.com"
account "eutonian" imap server "eutonian.ath.cx"
# The stdin account is disabled: it will be ignored unless explicitly requested
# using the -a switch on the command line.
account "stdin" disabled stdin

# Catch local mail early.
match "^From:.*root@[a-z]*.nicm.ath.cx" in headers account "stdin"
	action "inbox"

# ------------------------------------------------------------------------------
# I like to only keep mail in my maildirs for 30 days, after which it is 
# archived to mboxes which are easier to grep, and which I rm -Rf periodically.
# This section defines the rules fdm needs to do the archiving: with these, I
# can have cron run "fdm -vaarchive f" every 10 days or so, and everything is
# gravy.
# ------------------------------------------------------------------------------
account "archive" disabled maildirs { 
	"${path}/bugtraq"
	"${path}/forensics"
	"${path}/freebsd-hackers"
	"${path}/full-disclosure"
	"${path}/gnu-{gcc,gdb}"
	"${path}/linux-kernel"
	"${path}/marxism"
	"${path}/netbsd-{source-changes,tech-kern,tech-misc}"
	"${path}/news-{agvp,clax,clc,colds,csc,cubom,cui,cup}"
	"${path}/openbsd-{bugs,misc,ports,source-changes,tech}"
	"${path}/pf"
	"${path}/secureshell"
}
action "archive" mbox "${path}/%[maildir]-archives/%[maildir]-%yq%Q" compress

# Archive mail older than 30 days.
match age > 30 days account "archive" action "archive"

# Don't let any other mail get to the normal rules.
match all account "archive" action "keep"
# ------------------------------------------------------------------------------

# ------------------------------------------------------------------------------
# Spam from work account.
# ------------------------------------------------------------------------------
account "work" disabled imap server "agarcircuits.ath.cx" port 143 
	folder "Junk" keep
action "spam-work" maildir "${path}/spam-work"

match all account "work" action "spam-work"
# ------------------------------------------------------------------------------

# ------------------------------------------------------------------------------
# Newsgroups. These are disabled so I can run them using a "fdm -anews f" from
# a seperate cronjob less often than normal mail accounts.
# ------------------------------------------------------------------------------
action "news-alt.games.vga-planets" maildir "${path}/news-agvp"
action "news-comp.lang.asm.x86" maildir "${path}/news-clax"
action "news-comp.lang.c" maildir "${path}/news-clc"
action "news-comp.os.linux.development.system" maildir "${path}/news-colds"
action "news-comp.std.c" maildir "${path}/news-csc"
action "news-comp.unix.bsd.openbsd.misc" maildir "${path}/news-cubom"
action "news-comp.unix.programmer" maildir "${path}/news-cup"
action "news-comp.unix.internals" maildir "${path}/news-cui"

account "news" disabled nntp
	server "news.ntlworld.com"
	groups {
		"alt.games.vga-planets"
		"comp.lang.asm.x86"
		"comp.lang.c"
		"comp.os.linux.development.system"
		"comp.std.c"
		"comp.unix.bsd.openbsd.misc"
		"comp.unix.programmer"
		"comp.unix.internals"
	}
	cache "%h/.fdm.cache"

match all account "news" {
	match "\\<HTML\\>" in body action "junk"

	# comp.lang.c endless discussion/off-topic usual suspects
	match "^From:.*gazelle@xmission.xmission.com" in headers action "drop"
	match "^From:.*rlb@hoekstra-uitgeverij.nl" in headers action "drop"
	match "^From:.*rjh@see.sig.invalid" in headers action "drop"
	match "^From:.*spam@flash-gordon.me.uk" in headers action "drop"
	match "^From:.*fbkotler@verizon.net" in headers action "drop"
	match "^From:.*santosh.k83@gmail.com" in headers action "drop"
	match "^From:.*defaultuserbr@yahoo.com" in headers action "drop"
	match "^From:.*cbfalconer@yahoo.com" in headers and
		"top-post( |ing)" in body action "drop"
	match "^From:.*rgrdev@gmail.com" in headers action "drop"
	match "^From:.*chris@phaedsys.org" in headers action "drop"

	# Match based on the group name, this avoids problems with cross-
	# posting.
	match string "%[group]" to "alt.games.vga-planets"
		action "news-%[group]"
	match string "%[group]" to "comp.lang.asm.x86"
		action "news-%[group]"
	match string "%[group]" to "comp.lang.c"
		action "news-%[group]"
	match string "%[group]" to "comp.os.linux.development.system"
		action "news-%[group]"
	match string "%[group]" to "comp.std.c" 
		action "news-%[group]"
	match string "%[group]" to "comp.unix.bsd.openbsd.misc"
		action "news-%[group]"
	match string "%[group]" to "comp.unix.programmer"
		action "news-%[group]"
	match string "%[group]" to "comp.unix.internals"
		action "news-%[group]"
	match all action "drop"
}
# ------------------------------------------------------------------------------

# Copy invalid dates to a special action so I can inspect them.
match age invalid action "invalid" continue

# Test rewriting through cat.
match all action "cat" continue

# Test mbox delivery.
match size > 1K and size < 4K action "mbox" continue

# Drop HTML mail to gmail accounts.
match "\\<HTML\\>" in body account "gmail*" action "junk"

# Junk (eejits).
match ".*YAHOO.*BOOTER.*" in body action "junk"

# Junk (spam).
match "^From:.*@*.chase.com" in headers action "junk"
match "^From:.*@*.chaseonline.com" in headers action "junk"
match "^From:.*@citi-bank.com" in headers action "junk"
match "^From:.*@emaillabs.com" in headers action "junk"
match "^From:.*baypos@gmail.com" in headers action "junk"
match "^From:.*E-Greeting" in headers action "junk"

# Junk (ISP garbage).
match "^From:.*@newsletter.ntlworld.com" in headers action "junk"
match "^From:.*@newsletter.virginmedia.com" in headers action "junk"
match "^From:.*mailings@(gmx.net|gmx-gmbh.de)" in headers account "gmx"
	action "junk"

# Test add-header.
action "add-header" add-header "Lines"
	"%[lines]; body=%[body_lines]; header=%[header_lines]"
match all action "add-header" continue

# ------------------------------------------------------------------------------
# OpenBSD.  All my openbsd maildirs are named openbsd-<something>, where
# <something> is the same as the sender the mail comes from, so I can shorthand
# this by using a subexpression. We save the regexp subexpression as a tag
# called list, then the "openbsd" action delivers to a maildir called
# "openbsd-%[list]". I do need a special-case rule for gnats, which should go
# into openbsd-bugs as well as mails to bugs@, and announce, which I want in my
# inbox.
# ------------------------------------------------------------------------------
match "^Sender:[ \t]*owner-([a-z-]*)@openbsd\\.org" in headers {
	# Kill/filter actions.
	action "openbsd-filtered" maildir "${path}/openbsd-filtered" 
	action "openbsd-killed" maildir "${path}/openbsd-killed" 

	# Special-case announce.
	match string "%1" to "announce" action "inbox"

	# Tag the mail and fix gnats@.
	match all action tag "list" value "%1" continue
	match string "%[list]" to "gnats"
		action tag "list" value "bugs" continue

	# misc@ is way too high-traffic for a list some of which I actually
	# like to read, so aggressively filter it, aside from some people I
	# always want.
	$always = "@openbsd.org|@cvs.openbsd.org"
	$ignore = "ipsec|spamd|skype|ipv6|microsoft|linux|faster|gnu|ldap|" +
		"carp|pfsync|vpn|bgp|ospf|l2tp|ripd|printer|printing|" + 
		"opinion|pre-?orders?|ppp|kerberos|afs|\\[OT\\]|off-topic|" +
		"thanks|isos?|vmware|postfix|sasl|greytrap|isakmpd|wireless|" +
		"google|firefox|ipcomp|dovecot|apache|youtube|openoffice|php|" +
		"forum|clamav|wep"
	$unless = "panic"
	match string "%[list]" to "misc" and
		not "From:.*(${always})" in headers and
		"^Subject:.*(${ignore})" in headers and
		not "^Subject:.*(${unless})" in headers 
		actions { "openbsd-filtered" "mark-read" }

	# Drop any mail which is replying to a message-id on the ignore list.
	match not "From:.*(${always})" in headers {
		match "^References:[ \t]*(.*)" in headers and
			exec ${is_dead} returns (0, )
			actions { "openbsd-killed" "mark-read" }
		match "^In-Reply-To:[ \t]*(.*)" in headers and
			exec ${is_dead} returns (0, )
			actions { "openbsd-killed" "mark-read" }
	}

	# Drop eejits and add the message-ids to the ignore list.
	match "^From:.*clock@twibright.com" in headers
		actions { "die" "openbsd-killed" }
	match "^From:.*dfeustel@mindspring.com" in headers
		actions { "die" "openbsd-killed" }
	match "^From:.*eric-list-openbsd-misc@catastrophe.net" in headers
		actions { "die" "openbsd-killed" }
	match "^From:.*peter_philipp@freenet.de" in headers
		or "^From:.*philipp.peter@freenet.de" in headers
		actions { "die" "openbsd-killed" }
	match "^From:.*suck@my-balls.com" in headers
		actions { "die" "openbsd-killed" }
	match "^From:.*chefren@pi.net" in headers
		actions { "die" "openbsd-killed" }

 	# Deliver to openbsd-%[list].
	match all action maildir "${path}/openbsd-%[list]"
}
# ------------------------------------------------------------------------------

# netbsd
match "^Sender:[ \t]*([a-z-]*)-owner@NetBSD\\.org" in headers action "netbsd"

# pf
match "^Sender:[ \t]*owner-pf@benzedrine.cx" in headers action "pf"

# gnu (gcc, gdb)
match "^Sender: ([a-z]*)-owner@([a-z]*.gnu.org|sourceware.org)" in headers
	action "gnu"

# *@securityfocus.com (secureshell/bugtraq/forensics)
match "^List-Post:.*secureshell@securityfocus\\.com" in headers
	action "secureshell"
match "^List-Id:.*<([a-z-]*)\\.list-id\\.securityfocus\\.com>" in headers
	action "%1"

# full-disclosure
match "^List-Id:.*<full-disclosure\\.lists\\.grok\\.org\\.uk>" in headers
	action "full-disclosure"

# freebsd
match "^Sender:.*owner-freebsd-([a-z-]*)@freebsd\\.org" in headers {
	match string "%1" to "announce" action "inbox"
	match all action "freebsd-%1"
}

# marxism
match "^X-BeenThere:.*marxism@lists.econ.utah.edu" in headers 
	action "marxism"

# linux-kernel
match "^X-Mailing-List:.*linux-kernel@vger.kernel.org" in headers 
	or "^(To:|Cc:):.*@vger.kernel.org" in headers
	action "linux-kernel"

# openssh-unix-dev
match "X-BeenThere: openssh-unix-dev@mindrot.org" in headers
	action "openssh-unix-dev"

# default
match all action "inbox"
